services:
  v6y-postgres:
    image: postgres:18
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${PSQL_DB_USER}
      - POSTGRES_PASSWORD=${PSQL_DB_PASSWORD}
      - POSTGRES_DB=${PSQL_DB_NAME}
    ports:
      - "${PSQL_DB_PORT}:5432"
    volumes:
      - ./v6y-database/psql:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${PSQL_DB_USER} -d ${PSQL_DB_NAME}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  v6y-bff:
    build:
      context: .
      dockerfile: v6y-config/Dockerfile
      args:
        SERVICE_PATH: v6y-apps/bff
    command: pnpm run start:bff
    ports:
      - "4001:4001"
    image: ghcr.io/${REGISTRY_OWNER}/v6y-bff:latest
    environment:
      - PSQL_DB_HOST=${PSQL_DB_HOST}
      - PSQL_DB_NAME=${PSQL_DB_NAME}
      - PSQL_DB_USER=${PSQL_DB_USER}
      - PSQL_DB_PASSWORD=${PSQL_DB_PASSWORD}
      - PSQL_DB_PORT=${PSQL_DB_PORT}
      - GITLAB_PRIVATE_TOKEN=${GITLAB_PRIVATE_TOKEN}
      - GITHUB_PRIVATE_TOKEN=${GITHUB_PRIVATE_TOKEN}
      - JWT_SECRET=${JWT_SECRET}
      - V6Y_BFF_API_PATH=${V6Y_BFF_API_PATH}
      - V6Y_BFF_API_PORT=${V6Y_BFF_API_PORT}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  v6y-bfb-main-analyzer:
    build:
      context: .
      dockerfile: v6y-config/Dockerfile
      args:
        SERVICE_PATH: v6y-apps/bfb-main-analyzer
    command: pnpm run start:bfb:main
    ports:
      - "4002:4002"
    image: ghcr.io/${REGISTRY_OWNER}/v6y-bfb-main-analyzer:latest
    environment:
      - PSQL_DB_HOST=${PSQL_DB_HOST}
      - PSQL_DB_NAME=${PSQL_DB_NAME}
      - PSQL_DB_USER=${PSQL_DB_USER}
      - PSQL_DB_PASSWORD=${PSQL_DB_PASSWORD}
      - PSQL_DB_PORT=${PSQL_DB_PORT}
      - GITLAB_PRIVATE_TOKEN=${GITLAB_PRIVATE_TOKEN}
      - GITHUB_PRIVATE_TOKEN=${GITHUB_PRIVATE_TOKEN}
      - JWT_SECRET=${JWT_SECRET}
      - V6Y_MAIN_API_PATH=${V6Y_MAIN_API_PATH}
      - V6Y_MAIN_API_PORT=${V6Y_MAIN_API_PORT}
      - V6Y_STATIC_ANALYZER_API_PATH=${V6Y_STATIC_ANALYZER_API_PATH}
      - V6Y_DYNAMIC_ANALYZER_API_PATH=${V6Y_DYNAMIC_ANALYZER_API_PATH}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  v6y-bfb-static-code-auditor:
    build:
      context: .
      dockerfile: v6y-config/Dockerfile
      args:
        SERVICE_PATH: v6y-apps/bfb-static-auditor
    command: pnpm run start:bfb:static
    ports:
      - "4003:4003"
    image: ghcr.io/${REGISTRY_OWNER}/v6y-bfb-static-code-auditor:latest
    environment:
      - PSQL_DB_HOST=${PSQL_DB_HOST}
      - PSQL_DB_NAME=${PSQL_DB_NAME}
      - PSQL_DB_USER=${PSQL_DB_USER}
      - PSQL_DB_PASSWORD=${PSQL_DB_PASSWORD}
      - PSQL_DB_PORT=${PSQL_DB_PORT}
      - GITLAB_PRIVATE_TOKEN=${GITLAB_PRIVATE_TOKEN}
      - GITHUB_PRIVATE_TOKEN=${GITHUB_PRIVATE_TOKEN}
      - JWT_SECRET=${JWT_SECRET}
      - V6Y_STATIC_ANALYZER_API_PATH=${V6Y_STATIC_ANALYZER_API_PATH}
      - V6Y_STATIC_ANALYZER_API_PORT=${V6Y_STATIC_ANALYZER_API_PORT}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4003/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  v6y-bfb-url-dynamic-auditor:
    build:
      context: .
      dockerfile: v6y-config/Dockerfile
      args:
        SERVICE_PATH: v6y-apps/bfb-dynamic-auditor
    command: pnpm run start:bfb:dynamic
    ports:
      - "4004:4004"
    image: ghcr.io/${REGISTRY_OWNER}/v6y-bfb-url-dynamic-auditor:latest
    environment:
      - PSQL_DB_HOST=${PSQL_DB_HOST}
      - PSQL_DB_NAME=${PSQL_DB_NAME}
      - PSQL_DB_USER=${PSQL_DB_USER}
      - PSQL_DB_PASSWORD=${PSQL_DB_PASSWORD}
      - PSQL_DB_PORT=${PSQL_DB_PORT}
      - GITLAB_PRIVATE_TOKEN=${GITLAB_PRIVATE_TOKEN}
      - GITHUB_PRIVATE_TOKEN=${GITHUB_PRIVATE_TOKEN}
      - JWT_SECRET=${JWT_SECRET}
      - V6Y_DYNAMIC_ANALYZER_API_PATH=${V6Y_DYNAMIC_ANALYZER_API_PATH}
      - V6Y_DYNAMIC_ANALYZER_API_PORT=${V6Y_DYNAMIC_ANALYZER_API_PORT}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4004/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  v6y-bfb-devops-auditor:
    build:
      context: .
      dockerfile: v6y-config/Dockerfile
      args:
        SERVICE_PATH: v6y-apps/bfb-devops-auditor
    command: pnpm run start:bfb:devops
    ports:
      - "4005:4005"
    image: ghcr.io/${REGISTRY_OWNER}/v6y-bfb-devops-auditor:latest
    environment:
      - PSQL_DB_HOST=${PSQL_DB_HOST}
      - PSQL_DB_NAME=${PSQL_DB_NAME}
      - PSQL_DB_USER=${PSQL_DB_USER}
      - PSQL_DB_PASSWORD=${PSQL_DB_PASSWORD}
      - PSQL_DB_PORT=${PSQL_DB_PORT}
      - GITLAB_PRIVATE_TOKEN=${GITLAB_PRIVATE_TOKEN}
      - GITHUB_PRIVATE_TOKEN=${GITHUB_PRIVATE_TOKEN}
      - JWT_SECRET=${JWT_SECRET}
      - V6Y_DEVOPS_API_PATH=${V6Y_DEVOPS_API_PATH}
      - V6Y_DEVOPS_API_PORT=${V6Y_DEVOPS_API_PORT}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4005/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  v6y-frontend:
    build:
      context: .
      dockerfile: v6y-config/Dockerfile
      args:
        SERVICE_PATH: v6y-apps/front
    command: pnpm run start:frontend
    ports:
      - "4007:4007"
    image: ghcr.io/${REGISTRY_OWNER}/v6y-frontend:latest
    environment:
      - NEXT_PUBLIC_V6Y_BFF_PATH=${NEXT_PUBLIC_V6Y_BFF_PATH}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4006/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  v6y-frontend-bo:
    build:
      context: .
      dockerfile: v6y-config/Dockerfile
      args:
        SERVICE_PATH: v6y-apps/front-bo
    command: pnpm run start:frontend:bo
    ports:
      - "4008:4008"
    image: ghcr.io/${REGISTRY_OWNER}/v6y-frontend-bo:latest
    environment:
      - NEXT_PUBLIC_V6Y_BFF_PATH=${NEXT_PUBLIC_V6Y_BFF_PATH}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4008/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mono-node-modules: null
